name: Deploy Status Check

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Wait for Render deploy
        run: |
          echo "â³ Aguardando deploy no Render..."
          sleep 120  # Aguarda 2 minutos para o deploy completar
          
      - name: Check API Health
        run: |
          echo "ğŸ” Verificando health check..."
          
          # Tenta atÃ© 10 vezes com intervalo de 30s
          for i in {1..10}; do
            echo "Tentativa $i/10..."
            
            # URL do seu serviÃ§o no Render
            if curl -f -s "https://api-solucoes-urbanas.onrender.com/health"; then
              echo "âœ… Health check OK!"
              echo "ğŸ‰ Deploy realizado com sucesso!"
              echo "âœ… API estÃ¡ funcionando corretamente"
              exit 0
            else
              echo "âŒ Health check falhou, tentando novamente em 30s..."
              if [ $i -eq 10 ]; then
                echo "ğŸ’¥ Deploy falhou ou API nÃ£o estÃ¡ respondendo"
                echo "âŒ Verifique os logs no Render Dashboard"
                exit 1
              fi
              sleep 30
            fi
          done